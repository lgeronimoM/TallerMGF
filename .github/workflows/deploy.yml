# .github/workflows/deploy.yml
name: Deploy TallerMGF to Local Kubernetes

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ” Verificar herramientas
      run: |
        echo "ğŸ³ Verificando Docker..."
        docker --version
        echo "â˜¸ï¸ Verificando kubectl..."
        kubectl version --client
        echo "ğŸ“¦ Verificando conexiÃ³n al cluster..."
        kubectl cluster-info

    - name: ğŸ—ï¸ Construir imagen Docker
      run: |
        echo "ğŸ”¨ Construyendo imagen tallermgf..."
        docker build -t tallermgf:latest .
        docker build -t tallermgf:${{ github.sha }} .
        echo "âœ… Imagen construida exitosamente"

    - name: ğŸš€ Desplegar a Kubernetes
      run: |
        echo "ğŸ“‹ Aplicando manifiestos..."
        
        # Aplicar namespace primero
        kubectl apply -f k8s/namespace.yaml
        
        # Crear deployment temporal con la imagen correcta
        sed "s|image:|image: tallermgf:latest|g" k8s/deployment.yaml > /tmp/deployment-temp.yaml
        
        # Aplicar manifiestos
        kubectl apply -f /tmp/deployment-temp.yaml
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/ingress.yaml

    - name: â³ Esperar deployment
      run: |
        echo "ğŸ• Esperando que el deployment estÃ© listo..."
        kubectl wait --for=condition=available --timeout=300s deployment/tallermgf -n tallermgf
        
    - name: ğŸ”„ Reiniciar deployment (para nueva imagen)
      run: |
        echo "ğŸ”„ Reiniciando deployment para usar nueva imagen..."
        kubectl rollout restart deployment/tallermgf -n tallermgf
        kubectl rollout status deployment/tallermgf -n tallermgf --timeout=300s

    - name: âœ… Verificar estado final
      run: |
        echo "ğŸ“Š Estado final del deployment:"
        kubectl get deployment tallermgf -n tallermgf -o wide
        
        echo ""
        echo "ğŸ“‹ Pods en ejecuciÃ³n:"
        kubectl get pods -n tallermgf -o wide
        
        echo ""
        echo "ğŸŒ Servicios:"
        kubectl get svc -n tallermgf
        
        echo ""
        echo "ğŸ”— Ingress:"
        kubectl get ingress -n tallermgf
        
        echo ""
        echo "ğŸ” Eventos recientes:"
        kubectl get events -n tallermgf --sort-by='.lastTimestamp' | tail -10
        
        # Verificar que los pods estÃ©n corriendo
        READY_PODS=$(kubectl get pods -n tallermgf -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}' | grep -c "True" || echo "0")
        if [ "$READY_PODS" -eq "0" ]; then
          echo "âŒ No hay pods listos"
          kubectl describe pods -n tallermgf
          exit 1
        else
          echo "âœ… $READY_PODS pod(s) listo(s)"
        fi

    - name: ğŸ“ InformaciÃ³n de acceso
      run: |
        echo ""
        echo "ğŸ‰ Â¡Deployment completado!"
        echo "==============================="
        echo "ğŸŒ URL: http://tallermgf.local"
        echo "ğŸ¥ Health: http://tallermgf.local/health"
        echo ""
        echo "Para verificar que todo funciona:"
        echo "  kubectl logs -f deployment/tallermgf -n tallermgf"
        echo ""
        echo "Para acceder localmente (si no tienes ingress):"
        echo "  kubectl port-forward svc/tallermgf-service 8080:80 -n tallermgf"
        echo "  Luego visita: http://localhost:8080"
