name: build-and-deploy
on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  build-push:
    name: Build & Push Image
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Login to GHCR
        if: ${{ secrets.GHCR_TOKEN != '' }}
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin
      
      - name: Build image
        run: |
          IMAGE="ghcr.io/OWNER/TallerMGF:${GITHUB_SHA}"
          docker build -t "$IMAGE" .
          docker tag "$IMAGE" ghcr.io/OWNER/TallerMGF:latest
      
      - name: Push image
        run: |
          docker push ghcr.io/OWNER/TallerMGF:${GITHUB_SHA}
          docker push ghcr.io/OWNER/TallerMGF:latest

  deploy:
    name: Deploy to Kubernetes
    needs: build-push
    runs-on: self-hosted
    env:
      KUBECONFIG: ${{ github.workspace }}/kubeconfig
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      # Si quieres inyectar un kubeconfig desde secret base64
      - name: Write kubeconfig from secret
        if: ${{ secrets.KUBE_CONFIG != '' }}
        run: |
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $KUBECONFIG
      
      - name: Ensure namespace
        run: |
          kubectl apply -f k8s/namespace.yaml
      
      - name: Update image tag in deployment
        run: |
          # parchea el deployment para usar la imagen de este commit
          kubectl -n tallermgf set image deployment/tallermgf-api \
            api=ghcr.io/OWNER/TallerMGF:${GITHUB_SHA} --record || true
      
      - name: Apply manifests (idempotent)
        run: |
          # primera vez aseguramos service y deployment
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          # kubectl apply -f k8s/ingress.yaml # si usas Ingress
      
      - name: Wait for rollout
        run: |
          kubectl -n tallermgf rollout status deployment/tallermgf-api --timeout=120s
      
      - name: Show service
        run: |
          kubectl -n tallermgf get svc tallermgf-svc -o wide
