# .github/workflows/deploy.yml
name: Deploy TallerMGF to Local Kubernetes

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ” Verificar herramientas
      run: |
        echo "ğŸ³ Verificando Docker..."
        docker --version
        echo "â˜¸ï¸ Verificando kubectl..."
        kubectl version --client
        echo "ğŸ“¦ Verificando conexiÃ³n al cluster..."
        kubectl cluster-info

    - name: ğŸ—ï¸ Construir imagen Docker
      run: |
        echo "ğŸ”¨ Construyendo imagen tallermgf..."
        docker build -t tallermgf:latest .
        docker build -t tallermgf:${{ github.sha }} .
        echo "âœ… Imagen construida exitosamente"

    - name: ğŸš€ Desplegar a Kubernetes
      run: |
        echo "ğŸ“‹ Aplicando manifiestos..."
        
        # Aplicar namespace primero
        kubectl apply -f k8s/namespace.yaml
        
        # Actualizar el deployment con la nueva imagen
        kubectl patch deployment tallermgf -n tallermgf -p '{"spec":{"template":{"spec":{"containers":[{"name":"tallermgf","image":"tallermgf:latest","imagePullPolicy":"Never"}]}}}}'
        
        # Aplicar el resto de manifiestos
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/ingress.yaml

    - name: â³ Esperar deployment
      run: |
        echo "ğŸ• Esperando que el deployment estÃ© listo..."
        kubectl wait --for=condition=available --timeout=300s deployment/tallermgf -n tallermgf
        
    - name: ğŸ”„ Reiniciar deployment (para nueva imagen)
      run: |
        echo "ğŸ”„ Reiniciando deployment para usar nueva imagen..."
        kubectl rollout restart deployment/tallermgf -n tallermgf
        kubectl rollout status deployment/tallermgf -n tallermgf --timeout=300s

    - name: âœ… Verificar estado
      run: |
        echo "ğŸ“Š Estado del deployment:"
        kubectl get pods -n tallermgf
        echo ""
        echo "ğŸŒ Servicios:"
        kubectl get svc -n tallermgf
        echo ""
        echo "ğŸ”— Ingress:"
        kubectl get ingress -n tallermgf

    - name: ğŸ“ InformaciÃ³n de acceso
      run: |
        echo ""
        echo "ğŸ‰ Â¡Deployment completado!"
        echo "==============================="
        echo "ğŸŒ URL: http://tallermgf.local"
        echo "ğŸ¥ Health: http://tallermgf.local/health"
        echo ""
        echo "Para verificar que todo funciona:"
        echo "  kubectl logs -f deployment/tallermgf -n tallermgf"
        echo ""
        echo "Para acceder localmente (si no tienes ingress):"
        echo "  kubectl port-forward svc/tallermgf-service 8080:80 -n tallermgf"
        echo "  Luego visita: http://localhost:8080"
