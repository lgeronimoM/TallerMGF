name: build-and-deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

jobs:
  build-push:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Login GHCR
        run: echo "${{ github.token }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
      - name: Build
        run: |
          IMAGE_SHA="ghcr.io/lgeronimoM/TallerMGF:${GITHUB_SHA}"
          docker build -t "$IMAGE_SHA" .
          docker tag "$IMAGE_SHA" ghcr.io/lgeronimoM/TallerMGF:latest
      - name: Push
        run: |
          docker push ghcr.io/lgeronimoM/TallerMGF:${GITHUB_SHA}
          docker push ghcr.io/lgeronimoM/TallerMGF:latest

  deploy:
    needs: build-push
    runs-on: self-hosted
    env:
      KUBECONFIG: ${{ github.workspace }}/kubeconfig
    steps:
      - uses: actions/checkout@v4
      - name: Prepare kubeconfig
        shell: bash
        run: |
          if [ -n "${{ secrets.KUBE_CONFIG }}" ]; then
            echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > "$KUBECONFIG"
          elif [ -f "$HOME/.kube/config" ]; then
            cp "$HOME/.kube/config" "$KUBECONFIG"
          else
            echo "No kubeconfig provided and none found on runner." >&2
            exit 1
          fi
      - name: Apply manifests
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
      - name: Rollout to this commit
        run: |
          kubectl -n tallermgf set image deployment/tallermgf-api \
            api=ghcr.io/lgeronimoM/TallerMGF:${GITHUB_SHA} --record || true
          kubectl -n tallermgf rollout status deployment/tallermgf-api --timeout=180s
      - name: Show service
        run: kubectl -n tallermgf get svc -o wide
