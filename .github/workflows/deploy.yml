name: Deploy TallerMGF to Local Kubernetes

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Construir imagen
      run: docker build -t tallermgf:${{ github.sha }} .

    - name: Aplicar manifiestos
      run: |
        # Reemplazar imagen en el deployment
        sed "s|tallermgf:latest|tallermgf:${{ github.sha }}|g" k8s/deployment.yaml > /tmp/deployment.yaml
        
        kubectl apply -f k8s/namespace.yaml
        kubectl apply -f /tmp/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/ingress.yaml

    - name: Verificar
      run: |
        kubectl get pods -n tallermgf
        echo "App disponible en: http://tallermgf.local"
